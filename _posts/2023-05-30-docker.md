---
title:  "도커(Docker)"
excerpt: "도커 이해하기"

categories:
  - Docker
tags:
  - [Docker Image, Docker Container]

toc: true
toc_sticky: true

date: 2023-05-30
last_modified_at: 2023-05-30
---

## Docker란  
소프트웨어 개발자가 Linux 컨테이너를 만들고 사용할 수 있도록 하는 **컨테이너 기반의 오픈 소스 가상화 플랫폼**  

개발자는 Docker를 사용하여 애플리케이션을 종속성과 함께 단일 컨테이너로 패키징하여 다양한 컴퓨팅 환경에서 **일관성과 이식성을 보장**할 수 있다. 또한, 소프트웨어 **개발 수명 주기를 간소화**하고 **리소스 활용도를 개선**하며 **확장성을 향상**할 수 있다.  

### 1. 도커 이미지(Docker Image)  
도커 컨테이너 생성 및 실행에 필요한 코드, 런타임, 시스템 도구, 라이브러리 및 종속성을 포함하여 애플리케이션을 실행하는데 필요한 모든 것을 포함하는 독립 실행형 실행 패키지  

이미지는 **특정 시점의 가상 환경과 애플리케이션을 나타내는 스냅샷**으로 **변경 불가한(immutable)** 읽기 전용 파일이다. 이러한 이미지는 자체로 실행되는 것은 아니고 런타임 환경을 위한 템플릿으로 사용된다. 덕분에 일관성이 보장되어 개발자는 동일한 조건에서 소프트웨어를 실행할 수 있다.  
- 도커 이미지 검색  
  ```bash  
  docker search {image}
  ```  
- 현재 Host 머신의 이미지 목록  
  ```bash  
  docker images
  ```  
- 특정 이미지 삭제  
  ```bash  
  docker image rm {image_id}
  ```  
  ```bash  
  docker image rm {image_name}
  ```  
<br><br>  

### 2. 도커 이미지 리포지토리  
#### 2-1. 도커 레지스트리(Docker Registry)  
**도커 이미지의 저장 및 배포 시스템**  

도커 레지스트리를 사용하면 조직에서 내부적으로 도커 이미지를 저장하고 공유하는 자체 개인 리포지토리를 호스팅하고 관리할 수 있다.  
(민감하거나 독점적인 이미지를 유지하여 보안을 강화)  

#### 2-2. 도커 허브(Docker Hub)  
빌드한 컨테이너 이미지를 저장하고 다른 사람과 공유할 수 있는 **중앙 집중식 리포지토리**  
(Docker에서 제공하는 클라우드 기반 공용 레지스트리의 특정 구현) (커뮤니티 기반 플랫폼 역할)  

도커 허브를 통해 도커 이미지의 버전 관리 및 배포가 가능하다.  
<br><br>  

### 3. Dockerfile  
도커 이미지를 생성하기 위한 **스크립트**  

**애플리케이션의 환경과 종속성을 정의**하여 다양한 개발, 테스트 및 프로덕션 환경에서 일관된 배포가 가능하다.  
배포 시 용량이 큰 이미지 파일보다는 Dockerfile 만 배포한 후 실행시켜 사용하도록 하면 편리하게 배포할 수 있다.  

- Dockerfile을 통한 이미지 빌드  
  ```bash  
  docker build -t {image_name} .
  ```  
- Dockerfile을 다른 파일명으로 작성 후 이미지 빌드  
  ```bash  
  docker build -t {image_name} -f {Dockerfile_name} .
  ```  
  명령어 마지막에 '.' 은 Dockerfile이 있는 현재 디렉토리로 빌드 컨텍스트가 된다.  
  빌드 컨텍스트를 기준으로 상위 폴더로 올라가게 되면 빌드 컨텍스트에서 벗어나는 것이므로 오류 발생의 원인이 된다.  
  (ex. Dockerfile 내 COPY 명령문에서 상대경로 작성 시 현재 디렉토리나 하위 디렉토리만 사용)  

#### 3-1. Dockerfile 작성법  
```Dockerfile
FROM {베이스 이미지:태그}

COPY {호스트 머신의 경로/파일 or 경로/폴더/} {이미지 내부의 경로 or 경로/폴더/}

RUN {이미지를 빌드하는 과정에서 실행할 명령어}  # 패키지 설치, 파일 다운로드, 코드 컴파일 같이 이미지 종속성 및 환경 구성

WORKDIR {컨테이너 내에서 작업할 디렉토리 설정}  # 베이스 이미지에 따라 이미 생성되어 있는 폴더가 있음
CMD [{"인터프리터"}, {"실행할 명령"}]          # 컨테이너가 실행될 때 실행할 명령
```  
도커는 Dockerfile에 나열된 명령문을 차례대로 수행하면서 이미지를 생성한다.  
COPY 명령문의 경우 호스트 머신 쪽에 폴더를 지정하면 폴더 내의 파일들이 모두 복사되므로, 이미지 내부 경로에 복사할 폴더의 이름을 작성해주면 기존 경로에 폴더가 생성되면서 폴더 및 폴더 내 파일들이 통째로 들어있게 된다.  
<br><br>  

### 4. 도커 컨테이너(Docker Container)  
애플리케이션을 실행하는 데 필요한 모든 필수 소프트웨어, 라이브러리 및 종속성을 포함하는 가볍고 격리된 환경  

이미지를 기반으로 여러 컨테이너를 생성할 수 있고, 컨테이너가 삭제되더라도 컨테이너를 생성할 때 사용한 이미지는 그대로 남아있다.  

컨테이너는 매우 가벼운 모듈식 가상 머신처럼 다룰 수 있으며 구축, 배포, 복사, 다른 환경으로 이동을 통해 애플리케이션을 클라우드에 최적화할 수 있다. 기본 운영 체제나 인프라에 관계없이 Docker를 지원하는 모든 시스템에서 배포 및 실행이 가능하다.  

컨테이너를 생성하면 쓰기 가능한 레이어가 읽기 전용 베이스 이미지 위에 추가되어 
<br><br>  

## Docker Compose란  
다중 컨테이너 Docker 애플리케이션을 정의하고 실행하기 위한 도구  

하나의 프로젝트를 진행하는데 여러 개의 컨테이너를 사용하는 경우, 각각의 컨테이너들을 번거롭게 개별적으로 컨트롤할 필요 없이 한번에 관리할 수 있도록 작업을 단순화한다.  

### 1. docker-compose.yml  
도커 컴포즈에서 사용하는 구성 파일  

서비스, 구성, 종속성 및 관계를 지정하여 여러 Docker 컨테이너를 단일 애플리케이션으로 정의하고 관리할 수 있게 해준다.  

#### 1-1. docker-compose.yml 작성법  
```yml  
version: {'설치한 도커 컴포즈의 버전'}
services:
  {서비스 명}:
    image: {사용할 베이스 이미지:태그}
    container_name: {생성할 컨테이너의 이름}
    ports:
      - "2181:2181"
    restart: always
```  

- docker-compose.yml 파일에 작성된 컨테이너 생성 및 백그라운드 실행  
  ```bash  
  docker-compose up -d
  ```  
  docker-compose.yml 파일이 존재하는 경로로 이동하여 실행한다.  
<br><br>  








## 우분투에서 도커 사용하기  
- 운영 체제  
  Ubuntu 20.04 LTS  
- 컨테이너  
  - Zookeeper  
  - Kafka  
  - InfluxDB  
  - Kafka-Consumer & InfluxDB write 

### docker 설치  
(docker 설치 방법)  

### docker-compose 설치  
(docker-compose 설치 방법)  

### docker-compose.yml 파일 작성  
zookeeper, kafka, influxdb는 공개되어 있는 이미지를 다운받아 베이스 이미지로 사용  

- docker-compose.yml  
  ```yml  
  version: '2.5.0'
  services:
    zookeeper:
      image: wurstmeister/zookeeper
      container_name: zookeeper
      ports:
        - "2181:2181"
      restart: always
    kafka:
      image: wurstmeister/kafka
      container_name: kafka
      ports:
        - "9092:9092"
      environment:
        KAFKA_ADVERTISED_HOST_NAME: 211.197.16.44
        KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      volumes:
        - /var/run/docker.sock:/var/run/docker.sock
      restart: always
    influxdb:
      image: influxdb:2.0
      container_name: influxdb
      ports:
        - "8086:8086"
      volumes:
        - type : bind
          source: /media/petabrew/hdd1/var/lib/influxdb/data
          target: /var/lib/influxdb2
        - type: bind
          source: /media/petabrew/hdd1/var/lib/influxdb/config
          target: /etc/influxdb2
      restart: always
  ```  
  [컨테이너 백그라운드 실행]  
  ```bash  
  docker-compose up -d
  ```  
  <br>  
- run.sh  
  ```bash  
  python3 /app/kafka_consumer_raw/main.py &
  python3 /app/kafka_consumer_target/main.py
  ```  
  '&'를 붙이면 파이썬 파일을 백그라운드로 실행하여 컨테이너에서 2개의 파이썬 코드를 동시에 실행시킬 수 있다.  
- Dockerfile  
  ```Dockerfile
  FROM python:3.8

  COPY /kafka_consumer_raw/ /app/kafka_consumer_raw/
  COPY /kafka_consumer_target/ /app/kafka_consumer_target/
  COPY run.sh /app/

  RUN pip install kafka-python==2.0.2 influxdb-client==1.35

  WORKDIR /app
  CMD ["/bin/bash", "/app/run.sh"]
  ```  
  [도커 이미지 빌드]  
  ```bash  
  docker build -t {image_name} .
  ```  
  [빌드한 이미지로 컨테이너 생성 및 실행]
  ```bash  
  docker run --name {container_name} -p 5001:80 -d --restart always {image_name}
  ```  
  호스트 머신의 5001 포트가 컨테이너 내부의 80 포트로 매핑되도록 지정  
  컨테이너가 중지되면 백그라운드로 항상 재시작  
